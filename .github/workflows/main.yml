name: Build and Deploy Pages
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install Dependencies
        run: |
          npm install -g markdown-to-json
          npm install -g handlebars
          npm install --save-dev prettier

      - name: Generate Pages Script
        run: |
          echo '#!/bin/bash' > generate_pages.sh
          echo '' >> generate_pages.sh
          echo 'echo "Generating Pages..."' >> generate_pages.sh
          echo '' >> generate_pages.sh
          echo 'markdown-to-json ./content --stdout |' >> generate_pages.sh
          echo '  handlebars -p ./templates/page.handlebars |' >> generate_pages.sh
          echo '  sed "s/<!DOCTYPE html>/<!DOCTYPE html>\\n<!-- This page was generated by generate_pages.sh -->/"' >> generate_pages.sh
          echo '  > ./public/index.html' >> generate_pages.sh
          echo '' >> generate_pages.sh
          echo 'echo "Pages Generated!"' >> generate_pages.sh

          echo '' >> generate_pages.sh
          echo 'prettier --write ./public/index.html' >> generate_pages.sh

          echo '' >> generate_pages.sh
          echo 'echo "HTML formatted with Prettier!"' >> generate_pages.sh

          chmod +x ./generate_pages.sh

      - name: Build Pages
        run: |
          ./generate_pages.sh
          
      - name: Deploy Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: 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
          publish_dir: ./public
